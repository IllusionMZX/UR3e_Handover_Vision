# UR3e木块跟踪系统 - 启动指南

## 问题诊断结果

根据TF树检查，发现以下问题：
1. ❌ **TF树断裂**: `camera_color_optical_frame` 没有连接到机器人TF树
2. ❌ **时间戳错误**: 代码使用了错误的时间戳方式查询TF
3. ⚠️ **工作空间限制过严**: 原始代码限制半径0.55m，UR3e实际可达0.85m

## 已修复的问题

### 1. TF时间戳问题
**问题**: 使用 `rclpy.time.Time().to_msg()` 导致TF查询失败
**修复**: 使用图像消息的时间戳 `self.latest_color.header.stamp`

### 2. 增强错误提示
**新增**: 
- TF变换检查，自动检测是否启动了手眼标定launch
- 详细的中文错误信息
- MoveIt错误代码解释

### 3. 工作空间优化
**调整**:
- 水平距离: 0.1-0.85m (原0.55m)
- Z轴高度: -0.05-0.7m (新增)

### 4. 四元数归一化
**修复**: orientation.w从0改为接近0的值，避免数值不稳定

## 正确的启动顺序

### 终端1: 启动UR机器人驱动
```bash
cd /root/workspace/ros_ur_driver
source install/setup.bash
ros2 launch ur_robot_driver ur_control.launch.py \
    ur_type:=ur3e \
    robot_ip:=<你的机器人IP> \
    launch_rviz:=false
```

### 终端2: 启动MoveIt
```bash
cd /root/workspace/ros_ur_driver
source install/setup.bash
ros2 launch ur_moveit_config ur_moveit.launch.py \
    ur_type:=ur3e \
    launch_rviz:=true
```

### 终端3: 启动RealSense相机
```bash
ros2 launch realsense2_camera rs_launch.py \
    align_depth.enable:=true \
    enable_color:=true \
    enable_depth:=true
```

### 终端4: 🔴 关键! 启动手眼标定TF发布
```bash
cd /root/workspace/ros_ur_driver
source install/setup.bash
ros2 launch src/moveit_calibration/camerapose2.launch.py
```

**这一步非常重要!** 它会发布 `wrist_3_link -> camera_color_optical_frame` 的变换

### 终端5: 运行TF诊断工具(可选)
```bash
cd /root/workspace/ros_ur_driver
source install/setup.bash
python3 src/moveit_calibration/diagnose_tf.py
```

检查输出，确保所有关键TF链都显示 ✓

### 终端6: 启动木块跟踪节点
```bash
cd /root/workspace/ros_ur_driver
source install/setup.bash
python3 src/moveit_calibration/verify_calibration.py
```

## 验证步骤

1. **检查TF树是否完整**
```bash
ros2 run tf2_ros tf2_echo base_link camera_color_optical_frame
```
应该看到持续输出的变换数据，不应该有错误

2. **检查相机数据**
```bash
ros2 topic hz /camera/camera/color/image_raw
ros2 topic hz /camera/camera/depth/image_rect_raw
```
应该看到30Hz左右的频率

3. **在RViz中添加TF显示**
- Add -> TF
- 检查是否能看到从base_link到camera_color_optical_frame的完整链

4. **观察调试图像**
```bash
ros2 run rqt_image_view rqt_image_view /calibration_verification/debug_image
```
应该看到绿色物体被矩形框标记

## 常见问题排查

### 问题1: "TF变换不可用"错误
**症状**: 日志显示 "TF变换不可用: camera_color_optical_frame -> base_link"
**原因**: 未启动camerapose2.launch.py
**解决**: 
```bash
ros2 launch /root/workspace/ros_ur_driver/src/moveit_calibration/camerapose2.launch.py
```

### 问题2: "目标超出工作范围"
**症状**: 日志显示水平距离超出0.1-0.85m
**原因**: 物体太远或TF标定不准
**解决**: 
1. 将物体放在机器人可达范围内(30-80cm)
2. 重新进行手眼标定

### 问题3: "规划失败"或"没有找到IK解"
**症状**: MoveIt执行失败，错误代码-10
**原因**: 目标位姿不可达或关节限位
**解决**:
1. 确认目标位置合理
2. 检查是否有碰撞
3. 尝试降低速度: 修改`max_velocity_scaling_factor`为0.05

### 问题4: 相机frame名称不匹配
**症状**: 找不到camera_color_optical_frame
**原因**: RealSense驱动发布的frame名称可能不同
**检查**:
```bash
ros2 topic echo /tf_static | grep camera
```
**修复**: 如果frame名称不是`camera_color_optical_frame`，需要:
1. 修改verify_calibration.py中的`self.camera_frame`
2. 重新生成camerapose2.launch.py（使用正确的frame名称）

## 调试技巧

### 1. 实时监控TF
```bash
# 在新终端
watch -n 1 'ros2 run tf2_ros tf2_echo base_link camera_color_optical_frame 2>&1 | head -10'
```

### 2. 查看MoveIt规划细节
在RViz中:
- MotionPlanning面板
- Planning选项卡
- 勾选 "Show Trail"

### 3. 调整HSV颜色阈值
如果绿色检测不准，修改verify_calibration.py中的:
```python
lower_green = np.array([40, 80, 80])   # [H, S, V]
upper_green = np.array([95, 255, 255])
```

## 性能优化建议

1. **减少运动频率**: 代码已添加5cm阈值，避免频繁运动
2. **降低速度**: max_velocity_scaling_factor = 0.1（已设置）
3. **跳过移动时的检测**: is_moving标志已实现

## 手眼标定数据验证

当前标定结果(camerapose2.launch.py):
- 平移: [-0.034, -0.103, 0.022] 米
- 旋转: [0.0004, 0.0001, 0.021, 0.9998] (四元数)

**看起来合理吗?**
- 相机距离手腕约10cm (合理)
- 主要偏移在Y方向 (侧装相机,合理)
- 旋转很小 (接近对齐,合理)

如果机械臂移动方向不对，可能需要重新标定。

## 下一步

系统启动后:
1. 将绿色木块放在相机视野内
2. 确保深度相机能看到木块（距离0.3-1.0m）
3. 观察终端日志，确认检测到木块
4. 机械臂应自动移动到木块上方15cm

祝调试顺利! 🚀
